name: Android CI (Full Build + Wrapper Fix)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Extract your ZIP project
      - name: ğŸ—œï¸ Extract project ZIP
        run: unzip -o GitSafe.zip -d extracted-project

      # 3ï¸âƒ£ Install dos2unix (to normalize gradlew)
      - name: âš™ï¸ Install dos2unix
        run: sudo apt-get update && sudo apt-get install -y dos2unix

      # 4ï¸âƒ£ Set up Java 17
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 5ï¸âƒ£ Set up Android SDK
      - name: ğŸ§© Set up Android SDK
        uses: android-actions/setup-android@v3

      # 6ï¸âƒ£ Make gradlew executable and fix line endings
      - name: ğŸ§¹ Prepare gradlew
        run: |
          cd extracted-project
          chmod +x gradlew
          dos2unix gradlew
          echo "gradlew verified:"
          file gradlew

      # 7ï¸âƒ£ Regenerate Gradle wrapper jar (if missing or broken)
      - name: ğŸ” Regenerate Gradle Wrapper JAR
        run: |
          cd extracted-project
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "âš ï¸ gradle-wrapper.jar missing â€” regenerating..."
            ./gradlew wrapper --gradle-version 8.7 --distribution-type all
          fi
          ls -l gradle/wrapper/

      # 8ï¸âƒ£ Verify Gradle
      - name: ğŸ§ª Verify Gradle Version
        run: |
          cd extracted-project
          ./gradlew --version

      # 9ï¸âƒ£ Build Debug & Release APKs
      - name: ğŸ—ï¸ Build Debug and Release APKs
        run: |
          cd extracted-project
          ./gradlew assembleDebug assembleRelease --stacktrace

      # ğŸ”Ÿ Upload artifacts
      - name: ğŸ“¦ Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: GitSafe-APKs
          path: |
            extracted-project/app/build/outputs/apk/debug/*.apk
            extracted-project/app/build/outputs/apk/release/*.apk