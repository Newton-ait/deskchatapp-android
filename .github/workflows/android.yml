name: Android CI (Full Build)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # âœ… Extract and use the projectâ€™s own gradle-wrapper.jar
      - name: Extract ZIP project
        run: |
          echo "ğŸ“¦ Extracting project..."
          mkdir -p extracted-project
          unzip -q GitSafe.zip -d extracted-project

          echo "âœ… Extracted structure:"
          ls -R extracted-project | head -n 50

      # âœ… Make gradlew executable and verify wrapper
      - name: Prepare Gradle Wrapper
        run: |
          cd extracted-project
          if [ ! -f gradlew ]; then
            echo "âŒ gradlew script missing in ZIP root."
            exit 1
          fi

          chmod +x gradlew
          echo "ğŸ§© Checking Gradle wrapper JAR..."
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "âŒ gradle-wrapper.jar missing. Please verify your ZIP contents."
            exit 1
          fi
          echo "âœ… gradle-wrapper.jar found:"
          ls -lh gradle/wrapper/gradle-wrapper.jar
          file gradle/wrapper/gradle-wrapper.jar

          echo "ğŸ§© Verifying Gradle version..."
          ./gradlew --version

      # ğŸ—ï¸ Build APKs
      - name: Build Debug and Release APKs
        run: |
          cd extracted-project
          ./gradlew clean assembleDebug assembleRelease --no-daemon

      # ğŸ“¦ Upload APKs
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: all-apks
          path: |
            extracted-project/**/build/outputs/**/*.apk

      # ğŸ§¾ Summary
      - name: CI Summary
        run: |
          echo "--------------------------------------"
          echo "âœ… Android CI Finished Successfully"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Branch: $GITHUB_REF_NAME"
          echo "--------------------------------------"