name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate ZIP structure
      run: |
        echo "ğŸ“¦ Checking GitSafe.zip structure..."
        if [ ! -f "GitSafe.zip" ]; then
          echo "âŒ GitSafe.zip not found in repository root"
          exit 1
        fi
        echo "âœ… GitSafe.zip found"
        
    - name: Clean extraction directory
      run: |
        echo "ğŸ§¹ Preparing clean workspace..."
        # Remove any existing extracted files to avoid conflicts
        find . -maxdepth 1 -type f -name "gradlew*" -delete
        find . -maxdepth 1 -type f -name "*.gradle" -delete
        rm -rf app/ gradle/ 2>/dev/null || true
        
    - name: Extract Android project
      run: |
        echo "ğŸ“‚ Extracting GitSafe.zip..."
        # Force overwrite all files without prompting
        unzip -o -q GitSafe.zip
        echo "âœ… Extraction complete"
        echo "ğŸ“ Current directory structure:"
        ls -la
        
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Validate Gradle Wrapper
      run: |
        echo "ğŸ” Validating Gradle wrapper..."
        if [ ! -f "gradlew" ]; then
          echo "âŒ gradlew not found at project root"
          exit 1
        fi
        chmod +x ./gradlew
        echo "âœ… Gradle wrapper is ready"
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Debug APK
      run: |
        echo "ğŸ—ï¸ Building Debug APK..."
        ./gradlew assembleDebug --no-daemon
        echo "âœ… Debug build complete"
        
    - name: Build Release APK
      run: |
        echo "ğŸ—ï¸ Building Release APK..."
        ./gradlew assembleRelease --no-daemon
        echo "âœ… Release build complete"
        
    - name: Run Unit Tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        ./gradlew test --no-daemon
        echo "âœ… Tests complete"
        
    - name: Lint Check
      run: |
        echo "ğŸ” Running lint..."
        ./gradlew lintDebug --no-daemon
        echo "âœ… Lint check complete"
        
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deskchat-apks
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/apk/release/*.apk
        retention-days: 30
        
    - name: Build Report
      run: |
        echo "ğŸ“Š Build Summary:"
        echo "âœ… Android Project: GitSafe (Root directory)"
        echo "âœ… APK Location: app/build/outputs/apk/"
        echo "âœ… Gradle Wrapper: Authentic and functional"
        echo "ğŸ‰ Build completed successfully!"