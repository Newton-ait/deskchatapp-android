name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Extract project
      run: |
        echo "ğŸ“‚ Extracting GitSafe.zip..."
        unzip -o -q GitSafe.zip
        echo "âœ… Extraction complete"
        
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Analyze project structure
      run: |
        echo "ğŸ” Project Analysis:"
        echo "Files in root:"
        ls -la
        echo "Gradle files:"
        find . -name "*.gradle" -type f | head -10
        echo "App directory:"
        ls -la app/ || echo "No app directory"
        
    - name: Create minimal working build.gradle
      run: |
        echo "ğŸ”§ Creating working build configuration..."
        
        # Backup original files
        cp build.gradle build.gradle.backup 2>/dev/null || true
        cp app/build.gradle app/build.gradle.backup 2>/dev/null || true
        
        # Create minimal root build.gradle
        cat > build.gradle << 'EOF'
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath "com.android.tools.build:gradle:8.1.0"
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # Remove Google Services from app/build.gradle if it exists
        if [ -f "app/build.gradle" ]; then
          sed -i '/com.google.gms.google-services/d' app/build.gradle
          sed -i '/apply plugin.*google-services/d' app/build.gradle
          echo "âœ… Removed Google Services plugin from app/build.gradle"
        fi
        
    - name: Build with verbose output
      run: |
        echo "ğŸ—ï¸ Building with system Gradle..."
        # Use installed gradle from Android setup
        gradle clean assembleDebug --no-daemon --stacktrace --info
        
    - name: Check for APK
      run: |
        echo "ğŸ” Searching for APK files..."
        find . -name "*.apk" -type f
        if [ -d "app/build/outputs" ]; then
          echo "ğŸ“ Build outputs:"
          ls -la app/build/outputs/
          find app/build/outputs/ -name "*.apk" -type f
        fi
        
    - name: Upload any found APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          app/build/outputs/
          *.gradle
          *.log
        retention-days: 30