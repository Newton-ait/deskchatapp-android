name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ğŸ—œï¸ Extract GitSafe project
        run: |
          echo "ğŸ” Extracting GitSafe.zip..."
          unzip -o GitSafe.zip -d extracted-project
          echo "âœ… Extraction complete"
          ls -R extracted-project || true

      - name: ğŸ§­ Locate Gradle Wrapper
        id: find_gradle
        run: |
          WRAPPER_PATH=$(find extracted-project -type f -path "*/gradlew" | head -n 1)
          if [ -z "$WRAPPER_PATH" ]; then
            echo "âŒ Gradle wrapper not found!"
            exit 1
          fi
          echo "gradle_path=$WRAPPER_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Gradle wrapper found at: $WRAPPER_PATH"

      - name: ğŸ”‘ Grant execute permission
        run: chmod +x ${{ steps.find_gradle.outputs.gradle_path }}

      - name: âš™ï¸ Build Debug & Release APKs
        run: |
          cd "$(dirname "${{ steps.find_gradle.outputs.gradle_path }}")"
          echo "ğŸ—ï¸ Building APKs..."
          ./gradlew clean assembleDebug assembleRelease --stacktrace

      - name: ğŸ“¦ Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeskChat-APKs
          path: |
            **/app/build/outputs/apk/debug/*.apk
            **/app/build/outputs/apk/release/*.apk