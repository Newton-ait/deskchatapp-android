name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate ZIP structure
      run: |
        echo "📦 Checking GitSafe.zip structure..."
        if [ ! -f "GitSafe.zip" ]; then
          echo "❌ GitSafe.zip not found in repository root"
          exit 1
        fi
        echo "✅ GitSafe.zip found"
        
    - name: Extract Android project
      run: |
        echo "📂 Extracting GitSafe.zip..."
        unzip -q GitSafe.zip
        echo "✅ Extraction complete"
        echo "📁 Current directory structure:"
        ls -la
        echo "📁 App directory contents:"
        ls -la app/ || echo "⚠️ No app directory found at root"
        
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Validate Gradle Wrapper
      run: |
        echo "🔍 Validating Gradle wrapper..."
        if [ ! -f "gradlew" ]; then
          echo "❌ gradlew not found at project root"
          exit 1
        fi
        chmod +x ./gradlew
        echo "✅ Gradle wrapper is ready"
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Debug APK
      run: |
        echo "🏗️ Building Debug APK..."
        ./gradlew assembleDebug --no-daemon
        echo "✅ Debug build complete"
        
    - name: Build Release APK
      run: |
        echo "🏗️ Building Release APK..."
        ./gradlew assembleRelease --no-daemon
        echo "✅ Release build complete"
        
    - name: Run Unit Tests
      run: |
        echo "🧪 Running unit tests..."
        ./gradlew test --no-daemon
        echo "✅ Tests complete"
        
    - name: Lint Check
      run: |
        echo "🔍 Running lint..."
        ./gradlew lintDebug --no-daemon
        echo "✅ Lint check complete"
        
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: deskchat-apks
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/apk/release/*.apk
        retention-days: 30
        
    - name: Build Report
      run: |
        echo "📊 Build Summary:"
        echo "✅ Android Project: GitSafe (Root directory)"
        echo "✅ APK Location: app/build/outputs/apk/"
        echo "✅ Gradle Wrapper: Authentic and functional"
        echo "🎉 Build completed successfully!"