name: ğŸ’¥ DeskChat Android CI

# ğŸš€ Trigger on push and pull request events to main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ğŸ§± Main build job
jobs:
  build:
    name: Build Android APKs
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Fetch code from your repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history for versioning if needed

      # 2ï¸âƒ£ Ensure the GitSafe folder exists and contains your Gradle files
      - name: Verify Project Structure
        run: |
          echo "ğŸ” Checking project structure..."
          if [ ! -d "GitSafe" ]; then
            echo "âŒ ERROR: 'GitSafe' directory not found at repo root."
            exit 1
          fi
          if [ ! -f "GitSafe/gradlew" ]; then
            echo "âŒ ERROR: gradlew missing in GitSafe/. Make sure wrapper is generated."
            exit 1
          fi
          echo "âœ… Project structure looks correct."

      # 3ï¸âƒ£ Set up Java environment
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 4ï¸âƒ£ Ensure gradlew is executable (important for Linux CI)
      - name: Grant Execute Permission for Gradlew
        run: chmod +x GitSafe/gradlew

      # 5ï¸âƒ£ Validate Gradle wrapper integrity (prevents corrupt builds)
      - name: Validate Gradle Wrapper
        working-directory: GitSafe
        run: ./gradlew wrapper --gradle-version 8.7 --distribution-type bin

      # 6ï¸âƒ£ Clean & build Debug + Release APKs
      - name: Build Debug and Release APKs
        working-directory: GitSafe
        run: |
          echo "ğŸ—ï¸ Building APKs..."
          ./gradlew clean assembleDebug assembleRelease --stacktrace

      # 7ï¸âƒ£ Upload artifacts (your APKs)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeskChat-APKs
          path: |
            GitSafe/app/build/outputs/apk/debug/*.apk
            GitSafe/app/build/outputs/apk/release/*.apk

      # 8ï¸âƒ£ Optional: Verify .jar dependencies exist where expected
      - name: Check for JAR dependencies
        run: |
          echo "ğŸ” Scanning for JARs..."
          find GitSafe -type f -name "*.jar" || echo "âš ï¸ No .jar files found."
          echo "âœ… JAR check complete."

      # 9ï¸âƒ£ Optional: Print summary for debug visibility
      - name: Final Summary
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo "APK output directory:"
          find GitSafe/app/build/outputs/apk -type f -name "*.apk" || true