name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: 🗜️ Extract GitSafe project
        run: |
          echo "🔍 Extracting GitSafe.zip..."
          unzip -o GitSafe.zip -d extracted-project
          echo "✅ Extraction complete"
          ls -R extracted-project || true

      - name: 🧭 Locate Gradle Wrapper
        id: find_gradle
        run: |
          WRAPPER_PATH=$(find extracted-project -type f -path "*/gradlew" | head -n 1)
          if [ -z "$WRAPPER_PATH" ]; then
            echo "❌ Gradle wrapper not found!"
            exit 1
          fi
          echo "gradle_path=$WRAPPER_PATH" >> $GITHUB_OUTPUT
          echo "✅ Gradle wrapper found at: $WRAPPER_PATH"

      - name: 🔑 Grant execute permission
        run: chmod +x ${{ steps.find_gradle.outputs.gradle_path }}

      - name: ⚙️ Build Debug & Release APKs
        run: |
          cd "$(dirname "${{ steps.find_gradle.outputs.gradle_path }}")"
          echo "🏗️ Building APKs..."
          ./gradlew clean assembleDebug assembleRelease --stacktrace

      - name: 📦 Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeskChat-APKs
          path: |
            **/app/build/outputs/apk/debug/*.apk
            **/app/build/outputs/apk/release/*.apk